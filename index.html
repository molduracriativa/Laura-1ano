<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<title>CÃ¢mera com Capa e Moldura</title>

<style>
:root {
    --accent:#25D366;
}
* { box-sizing:border-box; }

body {
    margin:0;
    background:#000;
    overflow:hidden;
    width:100vw;
    height:100dvh;
    font-family:sans-serif;
}

/* ===== CAPA ===== */
#startScreen {
    position:fixed;
    inset:0;
    background:url("capajpg.jpg") center/cover no-repeat;
    z-index:20;
    display:flex;
    align-items:flex-end;
    justify-content:center;
    padding:40px;
}

#startBtn {
    background:var(--accent);
    color:#fff;
    border:none;
    padding:14px 28px;
    font-size:16px;
    border-radius:30px;
}

/* ===== CAMERA ===== */
.frame,.stage {
    position:relative;
    width:100%;
    height:100%;
}

video,canvas,img {
    position:absolute;
    inset:0;
    width:100%;
    height:100%;
    object-fit:cover;
}

#camera { background:#000; }
#camera.mirrored { transform:scaleX(-1); }

#canvasPreview { z-index:3; }
#molduraImagePreview {
    z-index:5;
    pointer-events:none;
    display:none;
}

#canvasFinal { display:none; }
</style>
</head>

<body>

<!-- CAPA -->
<div id="startScreen">
    <button id="startBtn">Iniciar</button>
</div>

<!-- CAMERA -->
<div class="frame">
<div class="stage">

<video id="camera" autoplay playsinline muted></video>
<canvas id="canvasPreview"></canvas>
<canvas id="canvasFinal"></canvas>
<img id="molduraImagePreview" src="moldura1.png" />

</div>
</div>

<script>
const DPR = window.devicePixelRatio || 1;
const PHOTO_W = 1080, PHOTO_H = 1920;
const VIDEO_W = 1080, VIDEO_H = 1920;

let stream=null, isRecording=false, mediaRecorder, recordedChunks=[];
let usingFrontCamera=true;

const video = document.getElementById('camera');
const canvasPreview = document.getElementById('canvasPreview');
const ctxPreview = canvasPreview.getContext('2d');
const canvasFinal = document.getElementById('canvasFinal');
const ctxFinal = canvasFinal.getContext('2d');
const moldura = document.getElementById('molduraImagePreview');
const startScreen = document.getElementById('startScreen');

ctxPreview.imageSmoothingEnabled = true;
ctxPreview.imageSmoothingQuality = "high";
ctxFinal.imageSmoothingEnabled = true;
ctxFinal.imageSmoothingQuality = "high";

/* ===== CAMERA ===== */
async function initCamera(){
    stream = await navigator.mediaDevices.getUserMedia({
        video:{
            facingMode: usingFrontCamera ? "user":"environment",
            width:{ideal:3840},
            height:{ideal:2160}
        },
        audio:true
    });
    video.srcObject = stream;
    video.play();
    resizePreview();
    previewLoop();
}

function resizePreview(){
    canvasPreview.width = innerWidth * DPR;
    canvasPreview.height = innerHeight * DPR;
    ctxPreview.setTransform(DPR,0,0,DPR,0,0);
}
window.addEventListener("resize", resizePreview);

/* ===== DESENHO ===== */
function draw(ctx,w,h){
    if(!video.videoWidth) return;
    const vw=video.videoWidth, vh=video.videoHeight;
    ctx.clearRect(0,0,w,h);
    ctx.save();
    ctx.translate(w/2,h/2);
    if(usingFrontCamera) ctx.scale(-1,1);

    const r=vw/vh;
    let dw=w, dh=w/r;
    if(dh<h){ dh=h; dw=h*r; }
    ctx.drawImage(video,-dw/2,-dh/2,dw,dh);
    ctx.restore();
    ctx.drawImage(moldura,0,0,w,h);
}

function previewLoop(){
    draw(ctxPreview,innerWidth,innerHeight);
    requestAnimationFrame(previewLoop);
}

/* ===== FOTO ===== */
function takePhoto(){
    canvasFinal.width = PHOTO_W*DPR;
    canvasFinal.height = PHOTO_H*DPR;
    ctxFinal.setTransform(DPR,0,0,DPR,0,0);
    draw(ctxFinal,PHOTO_W,PHOTO_H);
    canvasFinal.toBlob(b=>{
        const a=document.createElement("a");
        a.href=URL.createObjectURL(b);
        a.download="foto.png";
        a.click();
    },"image/png",1);
}

/* ===== VIDEO ===== */
function startVideo(){
    isRecording=true;
    recordedChunks=[];
    canvasFinal.width = VIDEO_W*DPR;
    canvasFinal.height = VIDEO_H*DPR;
    ctxFinal.setTransform(DPR,0,0,DPR,0,0);

    function loop(){
        if(!isRecording) return;
        draw(ctxFinal,VIDEO_W,VIDEO_H);
        requestAnimationFrame(loop);
    }
    loop();

    const cs = canvasFinal.captureStream(30);
    stream.getAudioTracks().forEach(t=>cs.addTrack(t));

    mediaRecorder = new MediaRecorder(cs,{
        mimeType:"video/webm;codecs=vp9",
        videoBitsPerSecond:8000000
    });

    mediaRecorder.ondataavailable=e=>recordedChunks.push(e.data);
    mediaRecorder.onstop=()=>{
        const blob=new Blob(recordedChunks,{type:"video/webm"});
        const a=document.createElement("a");
        a.href=URL.createObjectURL(blob);
        a.download="video.webm";
        a.click();
    };
    mediaRecorder.start();
}

function stopVideo(){
    isRecording=false;
    mediaRecorder.stop();
}

/* ===== INICIAR ===== */
document.getElementById("startBtn").onclick = async ()=>{
    startScreen.style.display="none";
    moldura.style.display="block";
    await initCamera();
};

window.takePhoto=takePhoto;
window.startVideo=startVideo;
window.stopVideo=stopVideo;
</script>

</body>
</html>
