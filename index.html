<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
    <title>CÃ¢mera Pro - Fluidez HD</title>
    <style>
        :root { --accent: #25D366; --record: #ff0000; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: #000; color: #fff; overflow: hidden; width: 100vw; height: 100dvh; font-family: sans-serif; }

        .stage { position: relative; width: 100%; height: 100%; overflow: hidden; background: #000; }

        #camera {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            object-fit: cover; 
            image-rendering: -webkit-optimize-contrast;
        }
        #camera.mirrored { transform: scaleX(-1); }

        #canvasPreview, #videoPreview {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            object-fit: contain; background: black; display: none; z-index: 6;
        }
        
        #molduraImagePreview {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            object-fit: cover; object-position: bottom; pointer-events: none; z-index: 5; display: none;
        }

        #canvasFinal { display: none; }

        .ui-layer {
            position: absolute; inset: 0; pointer-events: none; z-index: 20;
            display: flex; flex-direction: column; justify-content: space-between; padding: 40px 20px;
        }

        .top-bar { display: flex; justify-content: space-between; pointer-events: auto; }
        .timer-badge { background: var(--record); padding: 5px 12px; border-radius: 12px; font-weight: bold; display: none; }

        .controls-bottom { display: flex; flex-direction: column; align-items: center; gap: 20px; pointer-events: auto; }
        
        .btn-ui {
            padding: 10px 20px; background: rgba(0,0,0,0.6); border: 1px solid #fff;
            border-radius: 20px; color: #fff; cursor: pointer; backdrop-filter: blur(5px);
        }

        .capture-controls { display: flex; gap: 40px; align-items: center; }
        .btn-photo { width: 60px; height: 60px; border-radius: 50%; border: 2px solid #fff; background: rgba(255,255,255,0.2); font-size: 28px; cursor: pointer; }
        .btn-video { 
            width: 85px; height: 85px; border-radius: 50%; border: 5px solid #fff; 
            background: rgba(255,255,255,0.1); cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .btn-video.recording { border-color: var(--record); background: rgba(255,0,0,0.3); }
        .stop-square { width: 30px; height: 30px; background: red; border-radius: 4px; }

        #startScreen {
            position: absolute; inset: 0; background: #000;
            background-image: url('capajpg.jpg'); background-size: cover; background-position: center;
            display: flex; align-items: center; justify-content: center; z-index: 100;
        }
        #startBtn { 
            padding: 25px 55px; font-size: 24px; font-weight: bold; border: none; 
            background: #FF5722; color: #fff; border-radius: 50px; cursor: pointer;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        #resultUI { 
            position: absolute; inset: 0; display: none; flex-direction: column; 
            align-items: center; justify-content: flex-end; padding-bottom: 50px; 
            z-index: 30; background: rgba(0,0,0,0.8);
        }
        .actions-box { display: flex; flex-direction: column; gap: 15px; width: 85%; pointer-events: auto; }
        .btn-res { padding: 20px; border-radius: 15px; border: none; font-weight: bold; font-size: 18px; cursor: pointer; text-align: center; text-decoration: none; }
    </style>
</head>
<body>

<div class="stage" id="stage">
    <video id="camera" autoplay playsinline muted></video>
    <canvas id="canvasPreview"></canvas> 
    <canvas id="canvasFinal"></canvas>
    <video id="videoPreview" playsinline controls></video>
    <img id="molduraImagePreview" src="" />

    <div class="ui-layer" id="cameraUI" style="display:none;">
        <div class="top-bar">
            <button class="btn-ui" id="switchBtn">ðŸ”„ INVERTER</button>
            <div id="recordingTimer" class="timer-badge">00:00</div>
        </div>
        <div class="controls-bottom">
            <div class="capture-controls">
                <button id="capturePhotoBtn" class="btn-photo">ðŸ“·</button>
                <button id="captureVideoBtn" class="btn-video">
                    <svg id="camIcon" viewBox="0 0 24 24" width="40" height="40" fill="white"><path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/></svg>
                    <div id="stopIcon" class="stop-square" style="display:none;"></div>
                </button>
            </div>
        </div>
    </div>

    <div id="resultUI">
        <div class="actions-box">
            <a id="downloadBtn" class="btn-res" style="background:var(--accent); color:#fff;">ðŸ“¥ BAIXAR AGORA</a>
            <button id="newPhotoBtn" class="btn-res" style="background:#444; color:#fff;">ðŸ”„ TIRAR OUTRA</button>
        </div>
    </div>

    <div id="startScreen">
        <button id="startBtn">INICIAR CÃ‚MERA</button>
    </div>
</div>

<script>
let usingFrontCamera = true;
let stream = null;
let isRecording = false;
let mediaRecorder = null;
let recordedChunks = [];
let recordingStartTime = 0;
let currentFileUrl = null;

const video = document.getElementById('camera');
const canvasFinal = document.getElementById('canvasFinal');
// ðŸ”¥ OtimizaÃ§Ã£o: Desynchronized ajuda na fluidez do Canvas
const ctxFinal = canvasFinal.getContext('2d', { alpha: false, desynchronized: true });
const molduraImg = document.getElementById('molduraImagePreview');

document.getElementById('startBtn').onclick = () => initCamera();
document.getElementById('switchBtn').onclick = switchCamera;
document.getElementById('capturePhotoBtn').onclick = takePhoto;
document.getElementById('captureVideoBtn').onclick = () => isRecording ? stopRecording() : startRecording();
document.getElementById('newPhotoBtn').onclick = resetCamera;

async function initCamera() {
    if (stream) stream.getTracks().forEach(t => t.stop());
    try {
        stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: usingFrontCamera ? 'user' : 'environment', width: { ideal: 1280 }, height: { ideal: 720 } },
            audio: true
        });
        video.srcObject = stream;
        video.onloadedmetadata = () => {
            video.play();
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('cameraUI').style.display = 'flex';
            molduraImg.src = 'moldura1.png';
            molduraImg.style.display = 'block';
            video.classList.toggle('mirrored', usingFrontCamera);
        };
    } catch (e) { alert("Erro ao acessar cÃ¢mera."); }
}

function drawFrame(ctx, w, h) {
    ctx.imageSmoothingEnabled = true;
    ctx.imageSmoothingQuality = 'medium'; // MÃ©dio garante fluidez sem perder muita nitidez
    
    ctx.save();
    if (usingFrontCamera) {
        ctx.translate(w, 0);
        ctx.scale(-1, 1);
    }

    const vRatio = video.videoWidth / video.videoHeight;
    const tRatio = w / h;
    let dW, dH, offsetX = 0, offsetY = 0;

    if (vRatio > tRatio) {
        dW = h * vRatio; dH = h;
        offsetX = (w - dW) / 2;
    } else {
        dW = w; dH = w / vRatio;
        offsetY = (h - dH) / 2;
    }

    ctx.drawImage(video, offsetX, offsetY, dW, dH);
    ctx.restore();

    if (molduraImg.complete) ctx.drawImage(molduraImg, 0, 0, w, h);
}

function takePhoto() {
    canvasFinal.width = 1080;
    canvasFinal.height = 1920;
    // Para foto, usamos qualidade mÃ¡xima pois Ã© um Ãºnico frame
    ctxFinal.imageSmoothingQuality = 'high';
    drawFrame(ctxFinal, 1080, 1920);

    if (currentFileUrl) URL.revokeObjectURL(currentFileUrl);
    canvasFinal.toBlob(blob => {
        currentFileUrl = URL.createObjectURL(blob);
        showResult(currentFileUrl, 'image');
    }, 'image/png', 0.95);
}

function startRecording() {
    isRecording = true;
    recordedChunks = [];
    document.getElementById('camIcon').style.display = 'none';
    document.getElementById('stopIcon').style.display = 'block';
    document.getElementById('captureVideoBtn').classList.add('recording');
    document.getElementById('recordingTimer').style.display = 'block';
    recordingStartTime = Date.now();

    // ðŸ”¥ OtimizaÃ§Ã£o: VÃ­deo em 720p para evitar travamentos
    canvasFinal.width = 720;
    canvasFinal.height = 1280;

    const recordingLoop = () => {
        if (!isRecording) return;
        drawFrame(ctxFinal, 720, 1280);
        updateTimer();
        requestAnimationFrame(recordingLoop);
    };
    recordingLoop();

    const canvasStream = canvasFinal.captureStream(24); // 24 FPS Ã© mais estÃ¡vel para web
    if (stream.getAudioTracks().length > 0) canvasStream.addTrack(stream.getAudioTracks()[0]);

    // ðŸ”¥ Escolha de codec mais leve (H264 / AVC)
    const mimeType = MediaRecorder.isTypeSupported('video/webm;codecs=h264') 
                     ? 'video/webm;codecs=h264' 
                     : 'video/webm';

    mediaRecorder = new MediaRecorder(canvasStream, { 
        mimeType: mimeType,
        videoBitsPerSecond: 4000000 // 4Mbps Ã© excelente e nÃ£o trava
    });

    mediaRecorder.ondataavailable = e => { if (e.data.size > 0) recordedChunks.push(e.data); };
    mediaRecorder.onstop = () => {
        if (currentFileUrl) URL.revokeObjectURL(currentFileUrl);
        const blob = new Blob(recordedChunks, { type: 'video/webm' });
        currentFileUrl = URL.createObjectURL(blob);
        showResult(currentFileUrl, 'video');
    };
    mediaRecorder.start();
}

function stopRecording() {
    isRecording = false;
    document.getElementById('camIcon').style.display = 'block';
    document.getElementById('stopIcon').style.display = 'none';
    document.getElementById('captureVideoBtn').classList.remove('recording');
    document.getElementById('recordingTimer').style.display = 'none';
    if (mediaRecorder) mediaRecorder.stop();
}

function showResult(url, type) {
    document.getElementById('resultUI').style.display = 'flex';
    const dl = document.getElementById('downloadBtn');
    dl.href = url;
    dl.download = type === 'image' ? `foto_${Date.now()}.png` : `video_${Date.now()}.webm`;

    if (type === 'image') {
        const preview = document.getElementById('canvasPreview');
        preview.style.display = 'block';
        preview.width = window.innerWidth;
        preview.height = window.innerHeight;
        preview.getContext('2d').drawImage(canvasFinal, 0, 0, preview.width, preview.height);
    } else {
        const vPreview = document.getElementById('videoPreview');
        vPreview.style.display = 'block';
        vPreview.src = url;
        vPreview.play();
    }
}

function resetCamera() {
    document.getElementById('resultUI').style.display = 'none';
    document.getElementById('canvasPreview').style.display = 'none';
    document.getElementById('videoPreview').style.display = 'none';
    document.getElementById('videoPreview').src = "";
    initCamera();
}

function switchCamera() {
    usingFrontCamera = !usingFrontCamera;
    initCamera();
}

function updateTimer() {
    const s = Math.floor((Date.now() - recordingStartTime) / 1000);
    document.getElementById('recordingTimer').innerText = `${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
}
</script>
</body>
</html>
