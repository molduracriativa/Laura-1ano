<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<title>CÃ¢mera Customizada - Alta Qualidade</title>

<style>
:root{
    --accent:#25D366;
    --record:#ff0000;
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{
    margin:0;background:#000;color:#fff;overflow:hidden;
    width:100vw;height:100dvh;font-family:sans-serif;
}
.frame,.stage{width:100%;height:100%;position:relative}
.stage{overflow:hidden;background:#111}

#camera{
    position:absolute;inset:0;
    width:100%;height:100%;
    object-fit:cover;background:#000;
}
#camera.mirrored{transform:scaleX(-1)}

#canvasPreview,#videoPreview{
    position:absolute;inset:0;
    width:100%;height:100%;
    object-fit:contain;
    display:none;z-index:6;background:#000;
}

#molduraImagePreview{
    position:absolute;inset:0;
    width:100%;height:100%;
    object-fit:cover;
    object-position:bottom;
    pointer-events:none;
    z-index:5;
    display:none;
}

#canvasFinal{display:none}

.ui-layer{
    position:absolute;inset:0;
    z-index:20;
    display:flex;
    flex-direction:column;
    justify-content:space-between;
    padding:20px;
    pointer-events:none;
}

.top-bar{
    display:flex;
    justify-content:space-between;
    pointer-events:auto;
}

.timer-badge{
    background:var(--record);
    padding:5px 12px;
    border-radius:12px;
    font-weight:bold;
    display:none;
}

.controls-bottom{
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:30px;
    pointer-events:auto;
}

.btn{
    padding:10px 16px;
    border-radius:20px;
    background:rgba(0,0,0,.6);
    border:2px solid rgba(255,255,255,.3);
    color:#fff;
    font-weight:600;
}

.btn-frame{border-color:var(--accent)}

.capture-controls{display:flex;gap:20px}

.action-btn-mini{
    width:50px;height:50px;
    border-radius:50%;
    border:2px solid #fff;
    background:rgba(255,255,255,.2);
    font-size:22px;
}

.action-btn-large{
    width:80px;height:80px;
    border-radius:50%;
    border:4px solid #fff;
    background:rgba(255,255,255,.2);
}

.action-btn-large.recording{
    border-color:var(--record);
    background:rgba(255,0,0,.5);
}

#startScreen{
    position:absolute;inset:0;
    background:url('capajpg.jpg') center/cover no-repeat;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    z-index:50;
    text-align:center;
}

#startBtn{
    padding:18px 32px;
    font-size:20px;
    border:none;
    border-radius:50px;
    background:#FF5722;
    color:#fff;
}

#resultUI .actions{
    display:none;
    flex-direction:column;
    gap:12px;
    pointer-events:auto;
}

.action-btn{
    padding:14px;
    border-radius:12px;
    border:none;
    font-size:16px;
}

.btn-save{background:var(--accent)}
.btn-new{background:#555}

.flash{
    position:absolute;inset:0;
    background:#fff;
    opacity:0;
    pointer-events:none;
    z-index:10;
}
</style>
</head>

<body>

<div class="frame">
<div class="stage">

<video id="camera" autoplay playsinline muted></video>
<canvas id="canvasPreview"></canvas>
<canvas id="canvasFinal"></canvas>
<video id="videoPreview" playsinline controls></video>

<img id="molduraImagePreview" src="moldura1.png" alt="Moldura">

<div class="flash" id="flash"></div>

<div class="ui-layer" id="cameraUI" style="display:none">
    <div class="top-bar">
        <button class="btn" id="switchBtn">ðŸ”„ Trocar</button>
        <div id="recordingTimer" class="timer-badge">00:00</div>
    </div>

    <div class="controls-bottom">
        <button class="btn btn-frame">Foto 1</button>
        <div class="capture-controls">
            <button id="capturePhotoBtn" class="action-btn-mini">ðŸ“·</button>
            <button id="captureVideoBtn" class="action-btn-large"></button>
        </div>
    </div>
</div>

<div class="ui-layer" id="resultUI" style="display:none;align-items:center">
    <div class="actions">
        <a id="downloadBtn" class="action-btn btn-save">ðŸ“¥ Baixar</a>
        <button id="newPhotoBtn" class="action-btn btn-new">ðŸ”„ Novo</button>
    </div>
</div>

</div>
</div>

<div id="startScreen">
    <h2>ConfiguraÃ§Ã£o de CÃ¢mera</h2>
    <p>Permita acesso para iniciar</p>
    <button id="startBtn">INICIAR</button>
    <p id="errorMsg" style="color:red"></p>
</div>

<script>
const DPR=Math.max(1,window.devicePixelRatio||1);
let usingFrontCamera=true,stream=null,isRecording=false;
let mediaRecorder,recordedChunks=[],startTime,raf;

const video=document.getElementById('camera');
const canvasFinal=document.getElementById('canvasFinal');
const ctx=canvasFinal.getContext('2d');
const preview=document.getElementById('canvasPreview');
const pctx=preview.getContext('2d');

startBtn.onclick=()=>initCamera(true);
switchBtn.onclick=()=>{usingFrontCamera=!usingFrontCamera;initCamera(true)};
capturePhotoBtn.onclick=takePhoto;
captureVideoBtn.onclick=()=>isRecording?stopRec():startRec;
newPhotoBtn.onclick=reset;

async function initCamera(audio){
    if(stream) stream.getTracks().forEach(t=>t.stop());
    try{
        stream=await navigator.mediaDevices.getUserMedia({
            video:{
                facingMode:usingFrontCamera?'user':'environment',
                width:{ideal:1920},
                height:{ideal:1080}
            },
            audio
        });
        video.srcObject=stream;
        video.classList.toggle('mirrored',usingFrontCamera);
        video.play();
        startScreen.style.display='none';
        cameraUI.style.display='flex';
        molduraImagePreview.style.display='block';
    }catch{
        errorMsg.innerText='Erro ao acessar cÃ¢mera';
    }
}

function takePhoto(){
    const W=1080,H=1920;
    canvasFinal.width=W*DPR;
    canvasFinal.height=H*DPR;
    ctx.setTransform(DPR,0,0,DPR,0,0);
    draw(W,H);
    preview.width=W;
    preview.height=H;
    pctx.drawImage(canvasFinal,0,0,W,H);
    canvasFinal.toBlob(b=>show('image',b),'image/png',1);
}

function startRec(){
    isRecording=true;
    recordedChunks=[];
    captureVideoBtn.classList.add('recording');
    startTime=Date.now();

    const W=1080,H=1920;
    canvasFinal.width=W*DPR;
    canvasFinal.height=H*DPR;
    ctx.setTransform(DPR,0,0,DPR,0,0);

    (function loop(){
        if(!isRecording) return;
        draw(W,H);
        updateTimer();
        raf=requestAnimationFrame(loop);
    })();

    const cs=canvasFinal.captureStream(30);
    stream.getAudioTracks().forEach(t=>cs.addTrack(t));

    mediaRecorder=new MediaRecorder(cs,{
        mimeType:'video/webm;codecs=vp9',
        videoBitsPerSecond:8000000
    });

    mediaRecorder.ondataavailable=e=>recordedChunks.push(e.data);
    mediaRecorder.onstop=()=>{
        const blob=new Blob(recordedChunks,{type:'video/webm'});
        show('video',blob);
    };
    mediaRecorder.start();
}

function stopRec(){
    isRecording=false;
    captureVideoBtn.classList.remove('recording');
    cancelAnimationFrame(raf);
    mediaRecorder.stop();
    recordingTimer.style.display='none';
}

function draw(w,h){
    const vw=video.videoWidth,vh=video.videoHeight;
    if(!vw) return;

    ctx.save();
    ctx.translate(w/2,h/2);
    if(usingFrontCamera) ctx.scale(-1,1);

    const r=vw/vh;
    let dw=w,dh=w/r;
    if(dh<h){dh=h;dw=h*r}

    ctx.drawImage(video,-dw/2,-dh/2,dw,dh);
    ctx.restore();

    const img=molduraImagePreview;
    const ir=img.naturalWidth/img.naturalHeight;
    const ih=w/ir;
    ctx.drawImage(img,0,h-ih,w,ih);
}

function updateTimer(){
    const t=Math.floor((Date.now()-startTime)/1000);
    recordingTimer.style.display='block';
    recordingTimer.innerText=
        String(Math.floor(t/60)).padStart(2,'0')+':' +
        String(t%60).padStart(2,'0');
}

function show(type,blob){
    camera.style.display='none';
    molduraImagePreview.style.display='none';
    cameraUI.style.display='none';
    resultUI.style.display='flex';
    resultUI.querySelector('.actions').style.display='flex';

    const url=URL.createObjectURL(blob);
    downloadBtn.onclick=()=>{
        const a=document.createElement('a');
        a.href=url;
        a.download=type==='image'?'foto.png':'video.webm';
        a.click();
    };

    if(type==='video'){
        videoPreview.src=url;
        videoPreview.style.display='block';
    }else{
        preview.style.display='block';
    }
}

function reset(){
    camera.style.display='block';
    molduraImagePreview.style.display='block';
    preview.style.display='none';
    videoPreview.style.display='none';
    resultUI.style.display='none';
    cameraUI.style.display='flex';
}
</script>

</body>
</html>
