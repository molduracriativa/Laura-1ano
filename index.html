<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>CÃ¢mera Ultra Sharp HD</title>

<style>
:root { --accent:#25D366; --record:#ff0000; }
*{box-sizing:border-box}

body{
    margin:0;
    background:#000;
    width:100vw;
    height:100dvh;
    overflow:hidden;
    font-family:sans-serif;
}

.stage{position:relative;width:100%;height:100%}

video,canvas,img{
    position:absolute;
    inset:0;
    width:100%;
    height:100%;
    object-fit:cover;
}

#camera.mirrored{transform:scaleX(-1)}

#canvasPreview{z-index:3}
#molduraImagePreview{z-index:5;pointer-events:none;display:none}
#canvasFinal{display:none}

/* UI */
.ui-layer{
    position:absolute;
    inset:0;
    z-index:20;
    display:none;
    flex-direction:column;
    justify-content:space-between;
    padding:30px 20px;
    pointer-events:none;
}

.top-bar{display:flex;justify-content:space-between;pointer-events:auto}
.timer-badge{
    background:var(--record);
    padding:6px 12px;
    border-radius:12px;
    display:none;
}

.controls-bottom{
    display:flex;
    justify-content:center;
    pointer-events:auto;
}

.capture-controls{
    display:flex;
    gap:40px;
    align-items:center;
}

.btn-switch{
    background:rgba(0,0,0,.6);
    border:1px solid #fff;
    color:#fff;
    padding:10px 18px;
    border-radius:20px;
}

.btn-photo{
    width:55px;height:55px;
    border-radius:50%;
    border:2px solid #fff;
    background:rgba(255,255,255,.2);
    font-size:22px;
}

.btn-video{
    width:80px;height:80px;
    border-radius:50%;
    border:4px solid #fff;
    background:rgba(255,255,255,.1);
}
.btn-video.recording{
    border-color:var(--record);
    background:rgba(255,0,0,.3);
}

/* START */
#startScreen{
    position:absolute;
    inset:0;
    background:url("capajpg.jpg") center/cover no-repeat;
    display:flex;
    align-items:center;
    justify-content:center;
    z-index:100;
}

#startBtn{
    padding:24px 48px;
    font-size:22px;
    border:none;
    border-radius:50px;
    background:#FF5722;
    color:#fff;
}

/* RESULT */
#resultUI{
    position:absolute;
    inset:0;
    display:none;
    align-items:flex-end;
    justify-content:center;
    padding-bottom:50px;
    background:rgba(0,0,0,.7);
    z-index:30;
}

.actions-box{
    display:flex;
    flex-direction:column;
    gap:15px;
    width:80%;
}

.btn-res{
    padding:16px;
    border-radius:14px;
    border:none;
    font-size:16px;
}
</style>
</head>

<body>

<div class="stage">

<video id="camera" autoplay playsinline muted></video>
<canvas id="canvasPreview"></canvas>
<canvas id="canvasFinal"></canvas>
<img id="molduraImagePreview" src="moldura1.png">

<div class="ui-layer" id="cameraUI">
    <div class="top-bar">
        <button class="btn-switch" id="switchBtn">ðŸ”„ TROCAR</button>
        <div class="timer-badge" id="recordingTimer">00:00</div>
    </div>

    <div class="controls-bottom">
        <div class="capture-controls">
            <button class="btn-photo" id="photoBtn">ðŸ“·</button>
            <button class="btn-video" id="videoBtn"></button>
        </div>
    </div>
</div>

<div id="resultUI">
    <div class="actions-box">
        <a id="downloadBtn" class="btn-res" style="background:var(--accent);color:#fff;text-align:center">ðŸ“¥ SALVAR</a>
        <button class="btn-res" style="background:#444;color:#fff" onclick="location.reload()">ðŸ”„ NOVO</button>
    </div>
</div>

<div id="startScreen">
    <button id="startBtn">INICIAR AGORA</button>
</div>

</div>

<script>
const DPR = window.devicePixelRatio || 1;

let stream=null;
let usingFrontCamera=true;
let isRecording=false;
let mediaRecorder=null;
let chunks=[];
let startTime=0;
let rafId=null;

const video=document.getElementById("camera");
const canvasP=document.getElementById("canvasPreview");
const ctxP=canvasP.getContext("2d");
const canvasF=document.getElementById("canvasFinal");
const ctxF=canvasF.getContext("2d");
const moldura=document.getElementById("molduraImagePreview");

function resize(){
    canvasP.width=innerWidth*DPR;
    canvasP.height=innerHeight*DPR;
    ctxP.setTransform(DPR,0,0,DPR,0,0);
}
window.addEventListener("resize",resize);

async function initCamera(){
    if(stream) stream.getTracks().forEach(t=>t.stop());

    stream = await navigator.mediaDevices.getUserMedia({
        video:{
            facingMode:usingFrontCamera?"user":"environment",
            width:{ideal:3840},
            height:{ideal:2160}
        },
        audio:true
    });

    video.srcObject=stream;
    video.play();

    document.getElementById("startScreen").style.display="none";
    document.getElementById("cameraUI").style.display="flex";
    moldura.style.display="block";

    resize();
    previewLoop();
}

function draw(ctx,w,h){
    if(!video.videoWidth) return;

    ctx.clearRect(0,0,w,h);
    ctx.save();
    ctx.translate(w/2,h/2);
    if(usingFrontCamera) ctx.scale(-1,1);

    const r=video.videoWidth/video.videoHeight;
    let dw=w, dh=w/r;
    if(dh<h){ dh=h; dw=h*r; }

    ctx.drawImage(video,-dw/2,-dh/2,dw,dh);
    ctx.restore();
    ctx.drawImage(moldura,0,0,w,h);
}

function previewLoop(){
    draw(ctxP,innerWidth,innerHeight);
    requestAnimationFrame(previewLoop);
}

function takePhoto(){
    canvasF.width=1080*DPR;
    canvasF.height=1920*DPR;
    ctxF.setTransform(DPR,0,0,DPR,0,0);
    draw(ctxF,1080,1920);

    canvasF.toBlob(b=>{
        const url=URL.createObjectURL(b);
        showResult(url,"foto_hd.png");
    },"image/png",1);
}

function startVideo(){
    if(mediaRecorder && mediaRecorder.state!=="inactive"){
        mediaRecorder.stop();
    }

    isRecording=true;
    chunks=[];
    document.getElementById("videoBtn").classList.add("recording");
    document.getElementById("recordingTimer").style.display="block";
    startTime=Date.now();

    canvasF.width=1080*DPR;
    canvasF.height=1920*DPR;
    ctxF.setTransform(DPR,0,0,DPR,0,0);

    const loop=()=>{
        if(!isRecording) return;
        draw(ctxF,1080,1920);
        updateTimer();
        rafId=requestAnimationFrame(loop);
    };
    loop();

    const canvasStream = canvasF.captureStream(30);
    stream.getAudioTracks().forEach(t=>canvasStream.addTrack(t));

    mediaRecorder = new MediaRecorder(canvasStream,{
        mimeType:"video/webm;codecs=vp9",
        videoBitsPerSecond:8_000_000
    });

    mediaRecorder.ondataavailable=e=>{
        if(e.data.size>0) chunks.push(e.data);
    };

    mediaRecorder.onstop=()=>{
        cancelAnimationFrame(rafId);
        const blob=new Blob(chunks,{type:"video/webm"});
        chunks=[];
        showResult(URL.createObjectURL(blob),"video_hd.webm");
    };

    mediaRecorder.start(100);
}

function stopVideo(){
    if(!isRecording) return;
    isRecording=false;
    document.getElementById("videoBtn").classList.remove("recording");
    if(mediaRecorder && mediaRecorder.state!=="inactive") mediaRecorder.stop();
}

function showResult(url,name){
    document.getElementById("resultUI").style.display="flex";
    const dl=document.getElementById("downloadBtn");
    dl.href=url;
    dl.download=name;
}

function switchCamera(){
    usingFrontCamera=!usingFrontCamera;
    initCamera();
}

function updateTimer(){
    const s=Math.floor((Date.now()-startTime)/1000);
    document.getElementById("recordingTimer").innerText=
        `${String(Math.floor(s/60)).padStart(2,"0")}:${String(s%60).padStart(2,"0")}`;
}

document.getElementById("startBtn").onclick=initCamera;
document.getElementById("switchBtn").onclick=switchCamera;
document.getElementById("photoBtn").onclick=takePhoto;
document.getElementById("videoBtn").onclick=()=>isRecording?stopVideo():startVideo;
</script>

</body>
</html>
