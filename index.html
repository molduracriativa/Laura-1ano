<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
    <title>C칙mera HD - Moldura Profissional</title>
    <style>
        :root {
            --accent: #25D366;
            --record: #ff0000;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; background: #000; color: #fff; overflow: hidden;
            width: 100vw; height: 100dvh;
            font-family: sans-serif;
        }

        .frame { position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: #000; }
        .stage { position: relative; width: 100%; height: 100%; overflow: hidden; background: #111; }

        /* 游댠 Melhora a nitidez visual do elemento de v칤deo */
        #camera {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            object-fit: cover; 
            image-rendering: -webkit-optimize-contrast;
            background: black; 
            transition: transform 0.3s; 
        }
        #camera.mirrored { transform: scaleX(-1); }

        #canvasPreview, #videoPreview {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            object-fit: contain; background: black;
            display: none; z-index: 6;
        }
        
        #molduraImagePreview {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            object-fit: cover; object-position: bottom; pointer-events: none;
            z-index: 5; display: none;
        }

        #canvasFinal { display: none; }

        .ui-layer {
            position: absolute; inset: 0; pointer-events: none; z-index: 20;
            display: flex; flex-direction: column; justify-content: space-between; padding: 20px;
        }

        .top-bar { display: flex; justify-content: space-between; align-items: flex-start; pointer-events: auto; }

        .timer-badge {
            background: var(--record); padding: 5px 12px; border-radius: 12px;
            font-weight: bold; font-size: 16px; display: none; animation: pulse 1s infinite;
        }

        @keyframes pulse { 0%{opacity:1}50%{opacity:.7}100%{opacity:1} }

        .controls-bottom {
            display: flex; flex-direction: column; align-items: center; gap: 30px;
            pointer-events: auto; padding-bottom: 20px;
        }

        .btn {
            padding: 10px 16px; font-size: 14px; font-weight: 600;
            border: 2px solid rgba(255,255,255,0.3); border-radius: 20px;
            background: rgba(0,0,0,0.65); cursor: pointer; color: #fff;
        }

        .btn-frame { border-color: var(--accent); }

        .capture-controls { display: flex; gap: 20px; align-items: center; }

        .action-btn-mini {
            width: 50px; height: 50px; border-radius: 50%; border: 2px solid #fff;
            background: rgba(255,255,255,0.2); cursor: pointer;
            display: flex; align-items: center; justify-content: center; font-size: 24px;
        }

        .action-btn-large {
            width: 80px; height: 80px; border-radius: 50%;
            border: 4px solid #fff; background: rgba(255,255,255,0.2);
            cursor: pointer; display: flex; align-items:center; justify-content:center;
            transition: .2s;
        }

        .action-btn-large.recording { border-color: var(--record); background: rgba(255,0,0,.5); }

        .stop-icon { display: none; width:30px; height:30px; background:red; border-radius:4px; }

        #startScreen {
            position: absolute; inset: 0; background: #000;
            background-image: url('capajpg.jpg'); background-size: cover; background-position: center;
            display: flex; flex-direction: column; align-items:center; justify-content:center;
            gap: 20px; text-align:center; z-index: 50;
        }

        #startBtn { padding:18px 32px; font-size:20px; border:none; background:#FF5722; color:#fff; border-radius:50px; cursor:pointer; }

        #resultUI .actions { display:none; flex-direction:column; gap:12px; width:100%; max-width:300px; pointer-events:auto; }

        .action-btn { padding:14px; border-radius:12px; border:none; font-size:16px; cursor:pointer; font-weight: bold; }

        .btn-save { background:var(--accent); color: white; }
        .btn-new { background:#555; color: white; }

        .flash {
            position:absolute; inset:0; background:#fff; opacity:0; pointer-events:none;
            transition:.1s; z-index:10;
        }
    </style>
</head>
<body>

<div class="frame">
    <div class="stage" id="stage">
        <video id="camera" autoplay playsinline muted></video>
        <canvas id="canvasPreview"></canvas> 
        <canvas id="canvasFinal"></canvas>
        <video id="videoPreview" playsinline controls></video>

        <img id="molduraImagePreview" src="" />

        <div class="flash" id="flash"></div>

        <div class="ui-layer" id="cameraUI" style="display:none;">
            <div class="top-bar">
                <button class="btn" id="switchBtn">游댃 Trocar C칙mera</button>
                <div id="recordingTimer" class="timer-badge">00:00</div>
            </div>

            <div class="controls-bottom">
                <div class="capture-controls">
                    <button id="capturePhotoBtn" class="action-btn-mini">游닝</button>
                    <button id="captureVideoBtn" class="action-btn-large">
                        <svg class="cam-icon" viewBox="0 0 24 24" width="40" fill="white">
                            <path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/>
                        </svg>
                        <div class="stop-icon"></div>
                    </button>
                </div>
            </div>
        </div>

        <div class="ui-layer" id="resultUI" style="display:none; justify-content:flex-end; align-items:center;">
            <div class="actions">
                <a id="downloadBtn" class="action-btn btn-save" style="text-decoration: none; text-align: center;">游닌 Baixar Arquivo</a>
                <button id="newPhotoBtn" class="action-btn btn-new">游댃 Novo</button>
            </div>
        </div>
    </div>
</div>

<div id="startScreen">
    <h2 style="margin:0; color:#fff; text-shadow:0 0 5px #000;">C칙mera HD</h2>
    <p style="color:#fff; margin-top:5px; text-shadow:0 0 5px #000;">Qualidade m치xima ativada.</p>
    <button id="startBtn">INICIAR C츽MERA</button>
    <p id="errorMsg" style="color:red; font-size:12px; margin-top:10px;"></p>
</div>

<script>
const MOLDURAS = { 'm1': { type:'image', src:'moldura1.png' } };
let currentMolduraKey = 'm1';
let usingFrontCamera = true;
let stream = null;
let isRecording = false;
let mediaRecorder = null;
let recordedChunks = [];
let recordingStartTime = 0;
let animationFrameId = null;
let currentDownloadData = { blob:null, filename:null, url:null };

const video = document.getElementById('camera');
const videoPreview = document.getElementById('videoPreview');
const canvasPreview = document.getElementById('canvasPreview');
const ctxPreview = canvasPreview.getContext('2d');
const canvasFinal = document.getElementById('canvasFinal');
const ctxFinal = canvasFinal.getContext('2d', { alpha:false });
const molduraImagePreview = document.getElementById('molduraImagePreview');
const startScreen = document.getElementById('startScreen');
const cameraUI = document.getElementById('cameraUI');
const resultUI = document.getElementById('resultUI');
const recordingTimer = document.getElementById('recordingTimer');
const errorMsg = document.getElementById('errorMsg');
const downloadBtn = document.getElementById('downloadBtn');
const capturePhotoBtn = document.getElementById('capturePhotoBtn');
const captureVideoBtn = document.getElementById('captureVideoBtn');

document.getElementById('startBtn').addEventListener('click', () => initCamera(true));
document.getElementById('switchBtn').addEventListener('click', switchCamera);
document.getElementById('newPhotoBtn').addEventListener('click', resetCamera);
capturePhotoBtn.addEventListener('click', takePhoto);
captureVideoBtn.addEventListener('click', () => { isRecording ? stopRecording() : startRecording(); });
downloadBtn.addEventListener('click', triggerDownload);

async function initCamera(tryAudio = true) {
    if (stream) stream.getTracks().forEach(t => t.stop());

    // 游댠 CONFIGURA칂츾O HD OTIMIZADA
    const constraints = {
        video: { 
            facingMode: usingFrontCamera ? 'user' : 'environment',
            width: { ideal: 1920 }, // For칞a Full HD se dispon칤vel
            height: { ideal: 1080 },
            frameRate: { ideal: 30 }
        },
        audio: tryAudio
    };

    try {
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        handleStreamSuccess(stream);
    } catch (err) {
        if (tryAudio) initCamera(false);
        else errorMsg.innerText = "Erro ao acessar c칙mera HD!";
    }
}

function handleStreamSuccess(newStream) {
    stream = newStream;
    video.srcObject = stream;
    video.onloadedmetadata = () => {
        video.play();
        startScreen.style.display = 'none';
        cameraUI.style.display = 'flex';
        setMoldura('m1');
    };
}

function setMoldura(key) {
    currentMolduraKey = key;
    molduraImagePreview.src = MOLDURAS[key].src;
    molduraImagePreview.style.display = 'block';
}

function drawVideoToCanvas(ctx, w, h, mirror) {
    const vw = video.videoWidth;
    const vh = video.videoHeight;
    if (!vw || !vh) return;

    ctx.clearRect(0,0,w,h);
    
    // 游댠 FILTROS DE NITIDEZ E QUALIDADE
    ctx.imageSmoothingEnabled = true;
    ctx.imageSmoothingQuality = 'high';
    ctx.filter = 'contrast(1.05) brightness(1.02) saturate(1.1)'; // Sharpening visual

    ctx.save();
    ctx.translate(w/2, h/2);
    if (usingFrontCamera && mirror) ctx.scale(-1, 1);

    const vidRatio = vw / vh;
    let dw, dh;
    if (vidRatio > w/h) { dh = h; dw = h * vidRatio; }
    else { dw = w; dh = w / vidRatio; }

    ctx.drawImage(video, -dw/2, -dh/2, dw, dh);
    ctx.restore();
    ctx.filter = 'none'; // Reseta para a moldura sair com cor original
}

function drawImageLayer(ctx, img, w, h) {
    if (!img.complete || img.naturalWidth === 0) return;
    const ratio = img.naturalWidth / img.naturalHeight;
    const targetH = w / ratio;
    const y = h - targetH;
    ctx.drawImage(img, 0, y, w, targetH);
}

function takePhoto() {
    flashEffect();
    // Alta resolu칞칚o para Foto
    canvasFinal.width = 1080;
    canvasFinal.height = 1920;

    drawVideoToCanvas(ctxFinal, 1080, 1920, true);
    drawImageLayer(ctxFinal, molduraImagePreview, 1080, 1920);

    canvasPreview.width = stage.clientWidth;
    canvasPreview.height = stage.clientHeight;
    ctxPreview.drawImage(canvasFinal, 0, 0, canvasPreview.width, canvasPreview.height);

    canvasFinal.toBlob(blob => showResult('image', blob), 'image/png', 1.0);
}

function startRecording() {
    if (isRecording) return;
    isRecording = true;
    captureVideoBtn.classList.add('recording');
    recordingTimer.style.display = 'block';
    recordingStartTime = Date.now();
    recordedChunks = [];

    // Resolu칞칚o equilibrada para v칤deo (720p para evitar travamentos)
    canvasFinal.width = 720;
    canvasFinal.height = 1280;

    function loop() {
        if (!isRecording) return;
        drawVideoToCanvas(ctxFinal, 720, 1280, true);
        drawImageLayer(ctxFinal, molduraImagePreview, 720, 1280);
        updateTimer();
        animationFrameId = requestAnimationFrame(loop);
    }
    loop();

    const canvasStream = canvasFinal.captureStream(30);
    if (stream.getAudioTracks().length > 0) canvasStream.addTrack(stream.getAudioTracks()[0]);

    // 游댠 ALTO BITRATE PARA EVITAR BORR칏ES
    const options = { 
        mimeType: 'video/webm;codecs=vp9', 
        videoBitsPerSecond: 6000000 // 6 Mbps
    };

    try {
        mediaRecorder = new MediaRecorder(canvasStream, options);
    } catch(e) {
        mediaRecorder = new MediaRecorder(canvasStream, { videoBitsPerSecond: 6000000 });
    }

    mediaRecorder.ondataavailable = e => { if(e.data.size > 0) recordedChunks.push(e.data); };
    mediaRecorder.onstop = finishVideo;
    mediaRecorder.start();
}

function stopRecording() {
    isRecording = false;
    captureVideoBtn.classList.remove('recording');
    cancelAnimationFrame(animationFrameId);
    if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
    recordingTimer.style.display = 'none';
}

function finishVideo() {
    const blob = new Blob(recordedChunks, { type: 'video/webm' });
    showResult('video', blob);
}

function showResult(type, blob) {
    const url = URL.createObjectURL(blob);
    video.style.display = 'none';
    molduraImagePreview.style.display = 'none';
    cameraUI.style.display = 'none';
    resultUI.style.display = 'flex';
    resultUI.querySelector('.actions').style.display = 'flex';

    if (type === 'image') {
        canvasPreview.style.display = 'block';
        videoPreview.style.display = 'none';
        currentDownloadData = { blob, url, filename: `foto_${Date.now()}.png` };
        downloadBtn.innerText = "游닌 Baixar Foto HD";
    } else {
        canvasPreview.style.display = 'none';
        videoPreview.style.display = 'block';
        videoPreview.src = url;
        currentDownloadData = { blob, url, filename: `video_${Date.now()}.webm` };
        downloadBtn.innerText = "游닌 Baixar V칤deo HD";
    }
}

function resetCamera() {
    if (currentDownloadData.url) URL.revokeObjectURL(currentDownloadData.url);
    videoPreview.pause(); videoPreview.src = '';
    canvasPreview.style.display = 'none';
    videoPreview.style.display = 'none';
    video.style.display = 'block';
    molduraImagePreview.style.display = 'block';
    resultUI.style.display = 'none';
    cameraUI.style.display = 'flex';
}

async function switchCamera() {
    usingFrontCamera = !usingFrontCamera;
    await initCamera(true);
}

function updateTimer() {
    const diff = Math.floor((Date.now() - recordingStartTime) / 1000);
    const m = String(Math.floor(diff/60)).padStart(2,'0');
    const s = String(diff % 60).padStart(2,'0');
    recordingTimer.innerText = `${m}:${s}`;
}

function triggerDownload() {
    const a = document.createElement('a');
    a.href = currentDownloadData.url;
    a.download = currentDownloadData.filename;
    a.click();
}

function flashEffect() {
    const f = document.getElementById('flash');
    f.style.opacity = '1';
    setTimeout(() => f.style.opacity = '0', 150);
}
</script>
</body>
</html>
