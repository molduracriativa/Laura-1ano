<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
    <title>CÃ¢mera Custom Pro - HD</title>
    <style>
        :root {
            --accent: #25D366;
            --record: #ff0000;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; background: #000; color: #fff; overflow: hidden;
            width: 100vw; height: 100dvh;
            font-family: sans-serif;
        }

        .frame { position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: #000; }
        .stage { position: relative; width: 100%; height: 100%; overflow: hidden; background: #111; }

        #camera {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            object-fit: cover; 
            image-rendering: -webkit-optimize-contrast; /* Melhora nitidez no navegador */
            background: black; 
            transition: transform 0.3s; 
        }
        #camera.mirrored { transform: scaleX(-1); }

        #canvasPreview, #videoPreview {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            object-fit: contain; background: black;
            display: none; z-index: 6;
        }
        
        #molduraImagePreview {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            object-fit: cover; object-position: bottom; pointer-events: none;
            z-index: 5; display: none;
        }

        #canvasFinal { display: none; }

        .ui-layer {
            position: absolute; inset: 0; pointer-events: none; z-index: 20;
            display: flex; flex-direction: column; justify-content: space-between; padding: 30px 20px;
        }

        .top-bar { display: flex; justify-content: space-between; align-items: center; pointer-events: auto; }

        .timer-badge {
            background: var(--record); padding: 5px 12px; border-radius: 12px;
            font-weight: bold; font-size: 16px; display: none; animation: pulse 1s infinite;
        }

        @keyframes pulse { 0%{opacity:1} 50%{opacity:.7} 100%{opacity:1} }

        .controls-bottom {
            display: flex; flex-direction: column; align-items: center; gap: 25px;
            pointer-events: auto; padding-bottom: env(safe-area-inset-bottom, 20px);
        }

        .btn {
            padding: 12px 20px; font-size: 14px; font-weight: 600;
            border: 2px solid rgba(255,255,255,0.3); border-radius: 25px;
            background: rgba(0,0,0,0.6); cursor: pointer; color: #fff;
            backdrop-filter: blur(5px);
        }

        .capture-controls { display: flex; gap: 30px; align-items: center; }

        .action-btn-mini {
            width: 55px; height: 55px; border-radius: 50%; border: 2px solid #fff;
            background: rgba(255,255,255,0.2); cursor: pointer;
            display: flex; align-items: center; justify-content: center; font-size: 26px;
        }

        .action-btn-large {
            width: 85px; height: 85px; border-radius: 50%;
            border: 5px solid #fff; background: rgba(255,255,255,0.1);
            cursor: pointer; display: flex; align-items:center; justify-content:center;
            transition: transform 0.2s, background 0.2s;
        }
        .action-btn-large:active { transform: scale(0.9); }

        .action-btn-large.recording { border-color: var(--record); background: rgba(255,0,0,.4); }
        .stop-icon { display: none; width:30px; height:30px; background:red; border-radius:4px; }
        .action-btn-large.recording .cam-icon { display: none; }
        .action-btn-large.recording .stop-icon { display: block; }

        #startScreen {
            position: absolute; inset: 0; background: #000;
            background-image: url('capajpg.jpg'); background-size: cover; background-position: center;
            display: flex; flex-direction: column; align-items:center; justify-content:center;
            z-index: 100;
        }

        #startBtn { 
            padding: 20px 45px; font-size: 22px; font-weight: bold; border: none; 
            background: #FF5722; color: #fff; border-radius: 60px; cursor: pointer;
            box-shadow: 0 10px 25px rgba(0,0,0,0.4);
            transition: transform 0.2s;
        }
        #startBtn:active { transform: scale(0.95); }

        #resultUI .actions { display:none; flex-direction:column; gap:12px; width:100%; max-width:280px; pointer-events:auto; }
        .action-btn { padding:16px; border-radius:15px; border:none; font-size:16px; font-weight: bold; cursor:pointer; }
        .btn-save { background:var(--accent); color: #fff; }
        .btn-new { background:#444; color: #fff; }

        .flash {
            position:absolute; inset:0; background:#fff; opacity:0; pointer-events:none;
            transition:.1s; z-index:50;
        }
    </style>
</head>
<body>

<div class="frame">
    <div class="stage" id="stage">
        <video id="camera" autoplay playsinline muted></video>
        <canvas id="canvasPreview"></canvas> 
        <canvas id="canvasFinal"></canvas>
        <video id="videoPreview" playsinline controls></video>

        <img id="molduraImagePreview" src="" />

        <div class="flash" id="flash"></div>

        <div class="ui-layer" id="cameraUI" style="display:none;">
            <div class="top-bar">
                <button class="btn" id="switchBtn">ðŸ”„ Trocar CÃ¢mera</button>
                <div id="recordingTimer" class="timer-badge">00:00</div>
            </div>

            <div class="controls-bottom">
                <div class="capture-controls">
                    <button id="capturePhotoBtn" class="action-btn-mini" title="Tirar Foto">ðŸ“·</button>
                    <button id="captureVideoBtn" class="action-btn-large" title="Gravar VÃ­deo">
                        <svg class="cam-icon" viewBox="0 0 24 24" width="40" height="40" fill="white">
                            <path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/>
                        </svg>
                        <div class="stop-icon"></div>
                    </button>
                </div>
            </div>
        </div>

        <div class="ui-layer" id="resultUI" style="display:none; justify-content:center; align-items:center; background: rgba(0,0,0,0.5);">
            <div class="actions">
                <a id="downloadBtn" class="action-btn btn-save" style="text-decoration:none; text-align:center;">ðŸ“¥ SALVAR AGORA</a>
                <button id="newPhotoBtn" class="action-btn btn-new">ðŸ”„ TIRAR OUTRA</button>
            </div>
        </div>
    </div>
</div>

<div id="startScreen">
    <button id="startBtn">INICIAR CÃ‚MERA</button>
    <p id="errorMsg" style="color:red; font-size:14px; margin-top:20px; font-weight:bold;"></p>
</div>

<script>
const MOLDURAS = { 'm1': { src: 'moldura1.png' } };
let usingFrontCamera = true;
let stream = null;
let isRecording = false;
let mediaRecorder = null;
let recordedChunks = [];
let recordingStartTime = 0;
let animationFrameId = null;
let currentDownloadData = { url: null, filename: null };

const video = document.getElementById('camera');
const videoPreview = document.getElementById('videoPreview');
const canvasPreview = document.getElementById('canvasPreview');
const ctxPreview = canvasPreview.getContext('2d');
const canvasFinal = document.getElementById('canvasFinal');
const ctxFinal = canvasFinal.getContext('2d', { alpha: false });
const molduraImg = document.getElementById('molduraImagePreview');

// Botoes
const startBtn = document.getElementById('startBtn');
const switchBtn = document.getElementById('switchBtn');
const capturePhotoBtn = document.getElementById('capturePhotoBtn');
const captureVideoBtn = document.getElementById('captureVideoBtn');
const downloadBtn = document.getElementById('downloadBtn');
const newPhotoBtn = document.getElementById('newPhotoBtn');

startBtn.addEventListener('click', () => initCamera(true));
switchBtn.addEventListener('click', switchCamera);
capturePhotoBtn.addEventListener('click', takePhoto);
captureVideoBtn.addEventListener('click', () => isRecording ? stopRecording() : startRecording());
newPhotoBtn.addEventListener('click', resetCamera);
downloadBtn.addEventListener('click', triggerDownload);

async function initCamera(tryAudio = true) {
    if (stream) stream.getTracks().forEach(t => t.stop());

    const constraints = {
        video: { 
            facingMode: usingFrontCamera ? 'user' : 'environment',
            width: { ideal: 1920 }, // HD
            height: { ideal: 1080 }
        },
        audio: tryAudio
    };

    try {
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;
        video.onloadedmetadata = () => {
            video.play();
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('cameraUI').style.display = 'flex';
            molduraImg.src = MOLDURAS['m1'].src;
            molduraImg.style.display = 'block';
            if (usingFrontCamera) video.classList.add('mirrored');
            else video.classList.remove('mirrored');
        };
    } catch (err) {
        if (tryAudio) initCamera(false);
        else document.getElementById('errorMsg').innerText = "Erro: CÃ¢mera nÃ£o permitida.";
    }
}

function drawFrame(ctx, w, h) {
    const vw = video.videoWidth;
    const vh = video.videoHeight;
    if (!vw) return;

    ctx.imageSmoothingEnabled = true;
    ctx.imageSmoothingQuality = 'high';
    
    // ðŸ”¥ MELHORIA DE NITIDEZ: Leve contraste e brilho
    ctx.filter = 'contrast(1.08) brightness(1.02)';

    ctx.save();
    ctx.translate(w/2, h/2);
    if (usingFrontCamera) ctx.scale(-1, 1);

    const ratio = vw / vh;
    let dw, dh;
    if (ratio > w/h) { dh = h; dw = h * ratio; }
    else { dw = w; dh = w / ratio; }

    ctx.drawImage(video, -dw/2, -dh/2, dw, dh);
    ctx.restore();
    ctx.filter = 'none';

    // Desenha Moldura
    if (molduraImg.complete) {
        const mRatio = molduraImg.naturalWidth / molduraImg.naturalHeight;
        const mH = w / mRatio;
        ctx.drawImage(molduraImg, 0, h - mH, w, mH);
    }
}

function takePhoto() {
    const f = document.getElementById('flash');
    f.style.opacity = '1'; setTimeout(() => f.style.opacity = '0', 100);

    canvasFinal.width = 1080;
    canvasFinal.height = 1920;
    drawFrame(ctxFinal, 1080, 1920);

    canvasFinal.toBlob(blob => {
        const url = URL.createObjectURL(blob);
        showResult(url, `foto_${Date.now()}.png`, 'image');
    }, 'image/png', 1.0);
}

function startRecording() {
    isRecording = true;
    captureVideoBtn.classList.add('recording');
    document.getElementById('recordingTimer').style.display = 'block';
    recordingStartTime = Date.now();
    recordedChunks = [];

    canvasFinal.width = 720; // 720p para performance em vÃ­deo
    canvasFinal.height = 1280;

    function loop() {
        if (!isRecording) return;
        drawFrame(ctxFinal, 720, 1280);
        updateTimer();
        animationFrameId = requestAnimationFrame(loop);
    }
    loop();

    const canvasStream = canvasFinal.captureStream(30);
    if (stream.getAudioTracks().length > 0) canvasStream.addTrack(stream.getAudioTracks()[0]);

    mediaRecorder = new MediaRecorder(canvasStream, { 
        mimeType: 'video/webm;codecs=vp9', 
        videoBitsPerSecond: 6000000 
    });
    
    mediaRecorder.ondataavailable = e => recordedChunks.push(e.data);
    mediaRecorder.onstop = () => {
        const blob = new Blob(recordedChunks, { type: 'video/webm' });
        const url = URL.createObjectURL(blob);
        showResult(url, `video_${Date.now()}.webm`, 'video');
    };
    mediaRecorder.start();
}

function stopRecording() {
    isRecording = false;
    captureVideoBtn.classList.remove('recording');
    cancelAnimationFrame(animationFrameId);
    if (mediaRecorder) mediaRecorder.stop();
    document.getElementById('recordingTimer').style.display = 'none';
}

function showResult(url, filename, type) {
    currentDownloadData = { url, filename };
    video.style.display = 'none';
    molduraImg.style.display = 'none';
    document.getElementById('cameraUI').style.display = 'none';
    document.getElementById('resultUI').style.display = 'flex';
    document.querySelector('.actions').style.display = 'flex';

    if (type === 'image') {
        canvasPreview.style.display = 'block';
        videoPreview.style.display = 'none';
        canvasPreview.width = stage.clientWidth;
        canvasPreview.height = stage.clientHeight;
        ctxPreview.drawImage(canvasFinal, 0, 0, canvasPreview.width, canvasPreview.height);
    } else {
        canvasPreview.style.display = 'none';
        videoPreview.style.display = 'block';
        videoPreview.src = url;
    }
}

function resetCamera() {
    video.style.display = 'block';
    molduraImg.style.display = 'block';
    document.getElementById('resultUI').style.display = 'none';
    document.getElementById('cameraUI').style.display = 'flex';
    videoPreview.src = '';
    canvasPreview.style.display = 'none';
}

async function switchCamera() {
    usingFrontCamera = !usingFrontCamera;
    await initCamera(true);
}

function updateTimer() {
    const s = Math.floor((Date.now() - recordingStartTime) / 1000);
    const min = String(Math.floor(s/60)).padStart(2,'0');
    const sec = String(s%60).padStart(2,'0');
    document.getElementById('recordingTimer').innerText = `${min}:${sec}`;
}

function triggerDownload() {
    const a = document.createElement('a');
    a.href = currentDownloadData.url;
    a.download = currentDownloadData.filename;
    a.click();
}
</script>
</body>
</html>
